# Cloudflare CDN Setup Guide

This guide will help you set up Cloudflare as a CDN for your optimized images.

## Step 1: Sign up for Cloudflare

If you haven't already, sign up for a Cloudflare account at [cloudflare.com](https://www.cloudflare.com/).

## Step 2: Add Your Domain to Cloudflare

1. In your Cloudflare dashboard, click "Add a Site"
2. Enter your domain name and follow the setup instructions
3. Update your domain's nameservers to point to Cloudflare's nameservers

## Step 3: Set Up Cloudflare R2 Storage (Optional but Recommended)

For the best performance, use Cloudflare R2 Storage:

1. Go to the R2 section in your Cloudflare dashboard
2. Create a new bucket (e.g., `portfolio-images`)
3. Upload your optimized images to this bucket:
   - All files from `/public/images/` that were generated by the optimization script
   - Maintain the same directory structure

## Step 4: Create a Cloudflare Worker (Option 1)

1. Go to the Workers section in your Cloudflare dashboard
2. Create a new worker with a route like `yourname.cloudflare.com/*`
3. Use this worker script to serve images from your R2 bucket:

```js
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  const url = new URL(request.url)
  const path = url.pathname.replace(/^\//, '')
  
  // Get the object from R2
  const object = await R2_BUCKET.get(path)
  
  if (object === null) {
    return new Response('Not Found', { status: 404 })
  }
  
  // Set cache control headers
  const headers = new Headers()
  headers.set('Cache-Control', 'public, max-age=31536000')
  headers.set('Content-Type', object.httpMetadata.contentType || 'image/webp')
  
  return new Response(object.body, {
    headers
  })
}
```

## Step 5: Use Cloudflare Images (Option 2)

Alternatively, you can use Cloudflare Images service:

1. Go to the Images section in your Cloudflare dashboard
2. Upload your optimized images
3. Use the provided URLs in your application

## Step 6: Update Next.js Configuration

Update your `next.config.js` file with your actual Cloudflare domain:

```js
async rewrites() {
  return [
    {
      source: '/cdn-images/:path*',
      destination: 'https://yourname.cloudflare.com/:path*', // Replace with your actual Cloudflare domain
    },
  ];
},
```

## Step 7: Configure Cache Headers

In your Cloudflare dashboard:

1. Go to the Caching section
2. Set Browser Cache TTL to "Respect Existing Headers"
3. Set Edge Cache TTL to a high value (e.g., 1 month) for image files

## Step 8: Enable Cloudflare Features

Enable these Cloudflare features for optimal performance:

1. **Auto Minify**: Enable for HTML, CSS, and JavaScript
2. **Brotli**: Enable Brotli compression
3. **Rocket Loader**: Consider enabling for JavaScript
4. **HTTP/3**: Enable for faster connections
5. **Always Use HTTPS**: Enable to force HTTPS

## Step 9: Test Your CDN

1. Start your Next.js development server:
   ```bash
   npm run dev
   ```
2. Open your website and check if the images are loading from your Cloudflare CDN
3. Use browser developer tools to verify the image URLs and loading performance

## Troubleshooting

If images aren't loading from the CDN:

1. Check the browser console for errors
2. Verify that the Cloudflare worker/R2 setup is correct
3. Make sure the image paths in your code match the paths on your CDN
4. Check that the `useCdn` prop is set to `true` in your components

## Performance Monitoring

Use these tools to monitor your CDN performance:

1. Cloudflare Analytics in your dashboard
2. [PageSpeed Insights](https://pagespeed.web.dev/)
3. [WebPageTest](https://www.webpagetest.org/)

## Next Steps

Consider implementing:

1. Image preloading for critical images
2. Lazy loading for below-the-fold images
3. Responsive art direction for different screen sizes 